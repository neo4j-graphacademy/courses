= Importing CSV files with the Neo4j Data Importer
:repository: neo4j-graphacademy/importing-data
:repository-raw: https://raw.githubusercontent.com/{repository}
:path: main/modules/2-using-data-importer/lessons/2-c-importing-CSV
:zip-file: https://data.neo4j.com/importing/movieData.zip


== Data Importer Challenge

Welcome to **Neo4j Workspace**, the location for our challenge.
Neo4j Workspace is an online tool that combines developer tools into one convenient location.

* The **Explore** tab provides a no-code interface for exploring the guide.
* If you prefer to write Cypher, the **Query** tab provides a query window and multiple result panes.
* The tab you are on now is the **Import** tab, which allows you to map CSV data to your graph model and run a full import.

This challenge will take place in the Explore tab.

Click the **Next** button below to continue.

// ---------

== Your Challenge

Your challenge is to recreate and import the data model from the previous lesson using the Data Importer UI.

To refresh your memory, the final data model will be as follows:

image::{repository-raw}/{path}/images/movie-data-model.png[Movie Data Model,width=600,align=center]

The Data Importer has already been opened with your Neo4j Sandbox credentials provided.

In the next step, we will explore the zip archive that we will use to complete the challenge.

// ---------

== The Data

The {zip-file}[movieData.zip file^] file contains the following files:

* `persons.csv` - containing over 800 rows that will be used to create `(:Person)` nodes
* `movies.csv` - containing 93 rows that will be used to create `(:Movie)` nodes
* `acted_in.csv` - contains 372 rows that will be used to create the `(:Person)-[:ACTED_IN]->(:Movie)` pattern
* `directed.csv` - contains 99 rows that will be used to create the `(:Person)-[:DIRECTED]->(:Movie)` pattern
* `ratings.csv` is a denormalised file that contains users identified by the `userId` column, and their ratings for movies.

You may have also noticed the property types defined on the data model above.
When you define the mapping for the import, you will need to be mindful of the types that can be automatically mapped (string, integer, decimal, datetime) and that the key values for your properties may be different from what is in the CSV files.

Are you ready to get started?
Hit the **Next** button to continue.

// ---------

== 1. Download the CSV files

To import the files into Data Importer, you will first need to {zip-file}[download and unzip the zip archive^].
You can add import the files by dragging and dropping the files into the **Files** pane, or by clicking the btn:success[text="Add files",fill="text",icon="PlusSmIcon"] button to the top right of the pane.

Once you have added the files, the Files pane should look like this:

image::{repository-raw}/{path}/images/files-selected.png[Files added to Data Importer,width=600,align=center]

// TODO: Animated gif

[%collapsible]
.Are you having trouble?
====
You can also click the following button to add the CSV files directly into Workspace.

button::Add CSV Files to Workspace[role=NX_IMPORT_LOAD,endpoint={zip-file}]
====

Once you are done, take a few minutes to familiarize yourself with the headers used in each file and then click **Next** to create your first Node mapping.

// ---------

== 2. Creating the Person node mapping

Complete the following actions to add a `(:Person)` node to the data model.

=== 2.1. Add a new node

To create your first Node Mapping, click the btn:neutral[text="Add node",role="NX_IMPORT_ADD_NODE"] button located at the top left of the Modelling pane.
You should now see a new Node with a dashed border in the center of your data model.

=== 2.2. Set the node label

You can either set the _Label_ for the node by entering `Person` into the text box inside the **Mapping details** pane to the right of the data model, or by double-clicking on the node and typing `Person`.

=== 2.3 Select the `persons.csv` file

Information on people is stored in the `persons.csv` file, so select `persons.csv` from the *File* menu.

=== 2.4. Define the Node Properties

In the **Definition** tab, click the btn:primary[text="Select from file",role="NX_IMPORT_SHOW_MAPPING_PANE",icon="PlusSmIcon"] button.
// TODO: Make select from file clickable
A new dialog window should appear.
Check the *Select all* checkbox to the top right of the dialog, and click the **Confirm** button.

=== 2.5. Rename Properties

Four headers in the `persons.csv` file do not match our target data model:

* `person_tmdbId`
* `person_imdbId`
* `person_poster`
* `person_url`

Remove the `person_` prefix from each of these columns by clicking the icon:PencilIcon[] icon and updating the text box.
Once you have renamed the column, click the icon:CheckIcon[] icon to save the change.


// TODO: Only have one column to rename?

=== 2.6. Set the Unique ID

At the bottom of the **Mapping details** pane there is an ID dropdown menu.
Select `tmdbId` from the list to set this as the unique identifier for the import.

=== 2.7. Verifying this Step

You should now be able to see:

* Your data model has one node with a caption of Person and a solid border.
* In the Files pane, each of the columns listed under *persons.csv* should have a green indicator next to it.

image::{repository-raw}/{path}/images/person-properties-mapped.png[Person properties mapped,width=400,align=center]

[%collapsible]
.Are you having trouble?
====
If you cannot check each of the items above, run through the steps again to see if you have missed anything.
If you are still stuck, you can click the following button to add the Person node to the data model.

button::Add the Person node[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====

Once you have verified the steps above, click **Next** to define the Movie node in the data model.

// ---------

== 3. Define the Movie node mapping

Complete the following actions to add a `(:Movie)` node to the data model.

=== 3.1. Add a New Node

Click the btn:neutral[text="Add node",role="NX_IMPORT_ADD_NODE"] button to add a new node to the graph model.

=== 3.2. Update Mapping details

This time set the label to `Movie` and select *movies.csv* from the File dropdown.


=== 3.3. Define the Node Properties

In the **Definition** tab, click the btn:primary[text="Select from file",icon="PlusSmIcon",role="NX_IMPORT_SHOW_MAPPING_PANE"] button to open the **Select from file** dialog.
// TODO: role="NX_IMPORT_SHOW_MAPPING_PANE" to open dialog

As with the Person node, you can check the *Select all* checkbox to select all fields and click **Confirm** to add all columns.

Three column headers in this file don't match our data model; `movie_imdbId`, `movie_poster`, `movie_tmdbId` and `movie_url`.
Click the icon:PencilIcon[] icon next to each column and rename each column, removing the `movie_` prefix from each.
Once you have renamed the column, click the icon:CheckIcon[] icon to save the change.

The data types of two columns in this file do not match our data model; `budget` and `revenue`.
Use the icon:PencilIcon[] icon to update the data type of these columns to **integer**, clicking the icon:CheckIcon[] icon to save your changes.

[TIP]
.Genres column
====
You may notice that the genres column is a pipe-separated list of genres.
We will convert these values into nodes in an upcoming lesson.
====

=== 3.4. Set the Unique ID

Select `tmdbId` from the list of properties to set it as the unique identifier for each Movie.


=== 3.5 Verifying this Step

You should now be able to see that:

* There are two nodes in your data model, labeled **Person** and **Movie**.
* Both of these nodes should have a solid border.
* In the files pane, each column listed under *movies.csv* should have a green indicator next to it

image::{repository-raw}/{path}/images/movie-nodes-mapped.png[Movie nodes mapped,width=600,align=center]

[%collapsible]
.Are you having trouble?
====
If you cannot check each of the items above, run through the steps again to see if you have missed anything.
If you are still stuck, you can click the following button to add the Movie node to the data model.

button::Add the Movie node[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====

Once you have verified the steps above, click **Next** to define the User node in the data model.

// ---------

== 4. Define the User node mapping

In this step, you will map the `ratings.csv` file, which is a denormalized file that may contain multiple ratings per user.

The Data Importer will handle any data deduplication, using the link:https://neo4j.com/docs/cypher-manual/current/clauses/merge/[Cypher `MERGE` statement^] to find or create nodes based on the property selected in the *ID* dropdown.


=== 4.1. Add a New Node

Click the btn:neutral[text="Add node",role="NX_IMPORT_ADD_NODE"] located at the top left of the Modelling pane to add a new node to the data model.

=== 4.2. Update Mapping details

Set the label to **User** and select *ratings.csv* from the File dropdown.

=== 4.3. Define the Node Properties

In the **Definition** tab, click the btn:primary[text="Select from file",role="NX_IMPORT_SHOW_MAPPING_PANE",icon="PlusSmIcon"] button to open the **Select from file** dialog.

This file contains two columns that relate to a user:

* `userId`
* `name`

Select these columns from the list and click **Confirm** to add them to the Node definition.

[TIP]
--
The Data Importer will default all fields that end with `id` or `Id` as integers.
If there is one field with that name, it is automatically selected as the unique key.
You can always select a different unique key for your nodes.
--

=== 4.4. Set the Unique ID

As the `userId` column ends with `id`, the **ID** option should already be set.
If not, set the **ID** option to `userId`.


=== 4.5 Verifying this Step

You should now be able to see that:

* There are three circles in the Modelling pane labelled **Person**, **Movie** and **User**.
* Each of these nodes should have a solid border.
* In the files pane, the `userId` and `name` properties column listed under *ratings.csv* should have a green indicator next to them

image::{repository-raw}/{path}/images/user-nodes-mapped.png[User nodes mapped,width=600,align=center]

[%collapsible]
.Are you having trouble?
====
If you cannot check each of the items above, run through the steps again to see if you have missed anything.
If you are still stuck, you can click the following button to add the Movie node to the data model.

button::Add the Movie node[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====


Once you have verified the steps above, click **Next** to define the `-[:DIRECTED]->` relationship in the data model.

// ---------

== 5. Adding the DIRECTED relationship

To create a relationship between two nodes in the data model, move your mouse to the edge of a Node and drag the cursor to another node.

=== 5.1. Add the Relationship

Move your mouse to the edge of the **Person** node, click, and drag your mouse to the **Movie** node.
You should now see a new dashed line pointing from the **Person** node to the **Movie** node.

In the **Mapping details** pane, enter `DIRECTED` into the Relationship *Type* text box and select `directed.csv` from the *File* dropdown.

=== 5.2. Define the From and To columns

In the table below, you must select the columns in the CSV file that identify the nodes at the start and end of each relationship.

Select `person_tmdbId` as the *From* column, and `movieId` as the *To* column.
// TODO: Screenshot

=== 5.3. Define the Relationship Properties

There are no additional properties in this file, so no additional definitions are required.


=== 5.4. Verifying this Step

You should now be able to see that:

* A **DIRECTED** relationship has been defined from the **Person** node to the **Movie** node.
* The **DIRECTED** relationship should be a solid line.
* In the files pane, each column listed under `directed.csv` should have a green indicator next to it.

image::{repository-raw}/{path}/images/confirm-DIRECTED-done.png[DIRECTED relationships mapped,width=600,align=center]

[%collapsible]
.Are you having trouble?
====
If you cannot check each of the items above, run through the steps again to see if you have missed anything.
If you are still stuck, you can click the following button to add the Movie node to the data model.

button::Add the Movie node[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====

Once you have verified the steps above, click **Next** to define the `-[:ACTED_IN]->` relationship in the data model.

// ---------

== 6. Adding the ACTED_IN relationship

The `-[:ACTED_IN]->` relationship is similar to the `-[:DIRECTED]->` relationship, but instead is defined in the `acted_in.csv` file.


=== 6.1. Add the Relationship

Move your mouse to the edge of the **Person** node, click, and drag your mouse to the **Movie** node.
You should now see a new second relationship, drawn with dashed line from the **Person** node to the **Movie** node.

In the **Mapping details** pane, enter `ACTED_IN` into the Relationship *Type* text box and select `acted_in.csv` from the *File* dropdown.

=== 6.2. Define the From and To columns

In the table below, you must select the columns in the CSV file that identify the nodes at the start and end of each relationship.

Select `person_tmdbId` as the *From* column, and `movieId` as the *To* column.
// TODO: Screenshot

=== 6.3. Define the Relationship Properties

The `acted_in.csv` file contains one property, the `role` that the actor played.

In the **Definition** tab, click the btn:primary[text="Select from file",role="NX_IMPORT_SHOW_MAPPING_PANE",icon="PlusSmIcon"] to open the **Select from file** dialog.
Select the `role` column and click **Confirm**.


=== 6.4 Verifying this Step

You should now be able to see that:

* There are two relationships from the **Person** node to the **Movie** node, **ACTED_IN** and **DIRECTED**.
* Both relationships should be a solid line.
* In the files pane, each column listed under `directed.csv` should have a green indicator next to it.

image::{repository-raw}/{path}/images/acted-in-relationship-mapped.png[ACTED_IN relationships mapped,width=600,align=center]

[%collapsible]
.Are you having trouble?
====
If you cannot check each of the items above, run through the steps again to see if you have missed anything.
If you are still stuck, you can click the following button to add the Movie node to the data model.

button::Add the Movie node[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====


Once you have verified the steps above, click **Next** to define the `-[:RATED]->` relationship in the data model.


== 7. Adding the RATED relationship

In Step 4, we used the `ratings.csv` file to define the **User** node, but if you take a look in the Files pane, three columns have not yet been mapped.

We can use these unmapped columns to define the `-[:RATED]->` relationship between the **User** and **Movie** nodes.

=== 7.1. Add the Relationship

Move your mouse to the edge of the **User** node, click, and drag your mouse to the **Movie** node.
You should now see a new dashed line pointing from the **User** node to the **Movie** node.

In the **Mapping details** pane, enter `RATED` into the Relationship *Type* text box and select `ratings.csv` from the *File* dropdown.

=== 7.2. Define the From and To columns

In the table below, you must select the columns in the CSV file that identify the nodes at the start and end of each relationship.

Select `userId` as the *From* column, and `movieId` as the *To* column.
// TODO: Screenshot


=== 7.3. Define the Relationship Properties

The `ratings.csv` file contains two properties that should be attributed to this relationship, `rating` and `timestamp`.

In the **Definition** tab, click the btn:primary[text="Select from file",role="NX_IMPORT_SHOW_MAPPING_PANE",icon="PlusSmIcon"] to open the **Select from file** dialog.
Select the `rating` and `timestamp` columns and click **Confirm**.


=== 7.4. Update the rating data type

The `rating` property has been interpreted as a `float` when in fact it should be an `integer`.  Use the icon:PencilIcon[] icon to update the data type to `integer`.


=== 7.5 Verifying this Step

You should now be able to see that:

* A **RATED** relationship has been defined from the **User** node to the **Movie** node.
* The **RATED** relationship should be a solid line.
* In the files pane, each column listed under `ratings.csv` should have a green indicator next to it.

image::{repository-raw}/{path}/images/rated-relationships-mapped.png[RATED relationships mapped,width=600,align=center]

[%collapsible]
.Are you having trouble?
====
If you cannot check each of the items above, run through the steps again to see if you have missed anything.
If you are still stuck, you can click the following button to add the Movie node to the data model.

button::Add the Movie node[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====


**Great work!**  The data model is now complete.
In the next step, you will run the import and verify the results.


== 8. Preview the Import

You can preview the import by clicking the btn:success[text="Preview",role="NX_IMPORT_PREVIEW"] button at the top right-hand side of the Modelling pane.

button::Preview[role="NX_IMPORT_PREVIEW",color="primary"]

This action will open a modal window with a visualization of your graph.
You can use this visualization to preview the structure of the graph and the properties assigned to each node and relationship.

Once you are happy with the data model, you can run the import.
Click **Next** to continue.


== 9. Run the import

Now that your data model is complete, you can import the data into your Sandbox using the btn:success[text="Run import",role="NX_IMPORT_RUN"] button.

button::Run import[role="NX_IMPORT_RUN"]

Once complete, a modal window will appear with a summary of the import.
You can use this window to show the Cypher statements that have been run in the background.


[TIP]
.Downloading your Data Model
====
To save the data model, you can open the context menu using the icon:DotsHorizontalIcon[] menu and select *Download model*.
The *Download model (with data)* option will also include the CSV files used to create the data model.

You can use the *Open model* option in the same menu to open your downloaded data model.
====

=== Verifying the import

You can run the following Cypher statement in the **Query** tab to verify that the result are correct.

.Import Checklist
[source,cypher,role="button"]
----
CALL db.schema.nodeTypeProperties() YIELD nodeType, propertyName, propertyTypes
WITH apoc.map.fromPairs(collect([nodeType +'.'+ propertyName, propertyTypes])) AS nodeProperties

UNWIND [
  {condition: 'Person.tmdbId should be a number', nodeType: ':`Person`', propertyName: "tmdbId", expected: ["Long"] }
] AS row

WITH row, nodeProperties[ row.nodeType +'.'+ row.propertyName ] AS actual


RETURN row.condition AS condition, row.expected AS expected, actual, CASE WHEN row.expected THEN '✅' ELSE '❌' END as OK
----
// TODO: More conditions


// TODO: Run query in export tab or better yet, show results an inline


[%collapsible]
.Numbers don't match?
====
You can click the button below to load the solution.

button::Load the Solution[role=NX_IMPORT_LOAD,endpoint={zip-file}]
// TODO: Have a collapsible action that loads the model to the current stage
====


== Challenge Complete!

Head back to the link:https://graphacademy.neo4j.com/courses/importing-data/2-using-data-importer/2-c-importing-CSV/[Using Data Importer lesson on GraphAcademy ^] and click **Verify** button to complete the challenge.
