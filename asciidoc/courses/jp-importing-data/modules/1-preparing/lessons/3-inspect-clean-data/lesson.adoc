= インポート用データの検査
:type: quiz
:path: main/modules/1-preparing/lessons/3-inspect-clean-data

//[.video]
//video::bqSFY0g8Eno[youtube,width=560,height=315]

[.transcript]
== CSVデータの検査

ソースCSVデータを扱う前に、各行の区切り文字、引用符、特殊文字がどのように使用されているかを理解する必要があります。

ヘッダーとフィールドを表すデータが対応していない場合、データを読み込むことができません。
また、デフォルトのデリミタ "," の使用を想定できるかどうかも知っておく必要があります。そうでなければ、Cypher を使ってデータをインポートするときに、`LOAD CSV` と一緒に `FIELDTERMINATOR` キーワードを使用する必要があります。

CSVファイルをローカルにコピーしておけば、その中のデータを検査することができます。
実際のところ、Neo4j Data Importerを使用する場合、CSVファイルのローカルコピーが必要です。

=== Step 1: CSVを取得・ダウンロードする

CSVファイルがURLの場合は、Webブラウザでダウンロードし、ローカルに保存するだけでよい。

=== Step 2: デリミターを決定する

ファイルの内容（少なくとも最初の行）を見て、デリミタを決定する必要があります。

例えば、movies.csvファイルをエディターで表示すると以下のようになります。

image::{repository-raw}/{path}/images/file-in-editor.png[Movie CSV in editor,width=600,align=center]

CSVファイルには確かにヘッダー行があり、デリミタがカンマであることがわかります。また、フィールドには、文字列である値の周りに引用符がないように見えます。

=== Step 3: ヘッダーがフィールドと一致するかどうかを判断する

各行の長さによっては、フィールドの値が一定に見えるかどうかを判断するのが難しい場合があります。
CSVファイルなら、表計算ソフトで開けば、データを多少は確認することはできるでしょう。

movies.csvを表計算ソフトで表示すると、このように見えます：

image::{repository-raw}/{path}/images/file-in-sheet.png[Movie CSV in spreadsheet,width=600,align=center]

ここでは、行のデータがヘッダー行に対応していることがわかります。

*重要:* デフォルトでは、各行内のこれらのフィールドはすべて文字列型として読み込まれます。

また、このCSVファイルでは、国や言語などの複数値のフィールドは、「｜」文字で値が区切られていることに注意してください。

スプレッドシートでは、データを検査するのが少し簡単かもしれません。

=== Step 4: すべてのデータが読み取れるかどうかを判断する

CSVファイルからすべてのレコードがエラーなく読み込めることを確認する必要があります。

以下は、ヘッダーを含み、URLで指定されたCSVファイルの全データを読み込むCypherのコードです:

[source,Cypher,role=nocopy noplay]
----
include::{repository-raw}/{path}/load-csv.cypher[]
----

CSVファイルからすべての行を読み込み、読み込みに成功した行数を返します。
CSVファイルの読み込み中にエラーが発生した場合、test.csvファイルを読み込もうとすると、このようにエラーが表示されます。

image::{repository-raw}/{path}/images/error-reading-csv.png[Error reading CSV file,width=600,align=center]

この場合、エラーが発生した原因を調査し、CSVファイルを修正する必要があります。

===  Step 5: データはきれいな状態か判断する

以下は、データによって、データを扱う前に追加で確認することです:

* 引用符は正しく使われているか？
* 要素に値がない場合、空文字列が使用されるか？
* UTF-8の接頭辞は使用されてるか？（例： \uc）
* 一部のフィールドには、末尾にスペースがあるか？
* フィールドに2進数のゼロが含まれているか？
* リストがどのように形成されるか？（デフォルトではセパレーターにコロン(:)を使用）
* 明らかな誤字脱字はないか？

このコースでは、すでにクリーンアップされたデータを扱いますが、他のソースからCSVファイルを受け取った場合は、クリーンアップされていることを確認する必要があります。

== 理解度チェック

include::questions/1-clean.adoc[leveloffset=+1]

[.summary]
== まとめ

このレッスンでは、インポートしようとするデータでチェックすべきいくつかの事柄について学びました。
次の課題では、いくつかのCSVファイルを検査します。
