[.question]
= Replan Event Spike

After yesterday's deployment, you notice:

. Replan events: 5,000-8,000/minute (was 100-200/minute) - 40x increase
. CPU: Increased from 50% to 75%
. Query latency 50th percentile: Increased from 30ms to 85ms
. Query rate: Unchanged at 1,000/minute

Query logs show thousands of queries like:
----
MATCH (u:User {region: 'US'}) RETURN count(u)
MATCH (u:User {region: 'UK'}) RETURN count(u)
MATCH (u:User {region: 'DE'}) RETURN count(u)
... hundreds of unique region values
----

What is causing the replan spike and how do you fix it?

* [ ] Database schema changed - run statistics update

* [ ] Too many users - scale the instance

* [x] Queries use literal values instead of parameters - fix the queries

* [ ] Replan events are normal - no action needed

[TIP,role=hint]
.Hint
====
Look at the query pattern. Why would each unique region value cause a replan?
====

[TIP,role=solution]
.Solution
====
**Queries use literal values instead of parameters - fix the queries** is correct.

**Root cause**:

**What Neo4j sees**:
[source,cypher]
----
MATCH (u:User {region: 'US'}) RETURN count(u)  // Query 1
MATCH (u:User {region: 'UK'}) RETURN count(u)  // Query 2 (different!)
MATCH (u:User {region: 'DE'}) RETURN count(u)  // Query 3 (different!)
----

Each unique literal value creates a **completely different query** from Neo4j's perspective!

**The planning overhead**: Each unique query needs a new execution plan, resulting in 5,000-8,000 replans/minute of constant planning. Planning takes CPU (50% → 75%), planning takes time (latency 30ms → 85ms), and plans aren't reused (memory waste).

**The fix**:

**Before (BAD) - literals**:
[source,cypher]
----
// Application code
query = f"MATCH (u:User {{region: '{region}'}}) RETURN count(u)"
session.run(query)
// Creates new plan for each region!
----

**After (GOOD) - parameters**:
[source,cypher]
----
// Application code
query = "MATCH (u:User {region: $region}) RETURN count(u)"
session.run(query, region=region)
// Single plan reused for all regions!
----

**Impact of fix**: Replan rate drops from 5,000/min to 200/min (back to normal), CPU drops from 75% to 50% (planning overhead eliminated), latency drops from 85ms to 30ms (no constant replanning), and you have one cached plan vs. thousands of plans.

**Why parameters matter**: They enable query plan caching (same query, different data), improve performance (no repeated planning overhead), reduce memory usage (single plan vs. thousands), and free CPU for actual query execution.

The other options: Not a schema change (deployment introduced new code), not a scaling issue (same query rate), and a 40x increase is NOT normal (requires immediate fix).

**Key lesson**: Always use parameters (`$param`) not literals. One of the most common and easily fixable performance issues!
====

