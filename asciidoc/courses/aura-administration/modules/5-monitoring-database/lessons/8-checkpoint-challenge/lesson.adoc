=  Replan Event Investigation
:type: challenge
:order: 8


== Scenario

After a new feature deployment yesterday, you notice unusual activity in the database metrics.

**Replan Event metrics:**

* **Before deployment**: 100-200 replans per minute
* **After deployment**: 5,000-8,000 replans per minute (40x increase!)
* **Not stabilizing**: Still elevated 24 hours later

**Other metrics:**

* CPU usage: Increased from 50% to 75%
* Query latency 50th percentile: Increased from 30ms to 85ms

Query rate: Same as before (1,000 queries/minute)

Reviewing query logs for the new feature, you see thousands of queries like:

----
MATCH (u:User {region: 'US'}) RETURN count(u);
MATCH (u:User {region: 'UK'}) RETURN count(u);
MATCH (u:User {region: 'DE'}) RETURN count(u);
MATCH (u:User {region: 'FR'}) RETURN count(u);
MATCH (u:User {region: 'ES'}) RETURN count(u);
// ...hundreds of unique region values
----

Each unique region value creates a different query from Neo4j's perspective.


== The Challenge

What is causing the replan event spike and how should you fix it?


include::questions/1-replan-investigation.adoc[leveloffset=+1]


[.summary]
== Summary

High replan rates indicate queries using literal values instead of parameters. Fix the queries to use parameters so Neo4j can reuse execution plans instead of creating new ones for each unique value
* Plans aren't reused (memory waste)

**The fix - use parameters:**

[source,cypher]
.Bad - each region value triggers new plan
----
MATCH (u:User {region: 'US'}) RETURN count(u);
----

[source,cypher]
.Good - single plan reused for all regions
----
MATCH (u:User {region: $region}) RETURN count(u);
----

**Application code fix:**

[source,python]
.Before (bad)
----
query = f"MATCH (u:User {{region: '{region}'}}) RETURN count(u)"
session.run(query)
----

[source,python]
.After (good)
----
query = "MATCH (u:User {region: $region}) RETURN count(u)"
session.run(query, region=region)
----

**Why parameters matter:**

* **Single plan**: One plan cached and reused
* **Reduced CPU**: No repeated planning overhead
* **Better performance**: Queries execute faster
* **Memory efficient**: One plan vs. thousands

**After the fix:**

* Replan rate drops back to normal 100-200/minute
* CPU usage returns to 50%
* Query latency improves to previous levels

Performance restored

This is one of the most common performance issues and easiest to fix - always use parameters!

