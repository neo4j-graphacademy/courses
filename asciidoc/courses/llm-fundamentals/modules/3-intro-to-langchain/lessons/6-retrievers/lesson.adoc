= Retrievers


* Pivotal for Retrieval Augmented Generation (RAG)
* A retriever  is an interface that returns documents given an unstructured query
* They return a list of documents
* A Vector Retriever is an example

== Neo4jVector Retriever

* The `Neo4jVectorRetriever` is configured to connect to a Neo4j instance


=== Creating a new index

* You can create a vector index from langchain with a list of existing documents.
* The class will generate embeddings via the `embedding_provider` and store them in the index
* The following code creates an index called `myVectorIndex`

[source,python]
----
from langchain.embeddings.openai import OpenAIEmbeddings

embedding_provider = OpenAIEmbeddings()

new_index = Neo4jVector.from_documents(
    documents,
    embedding_provider,
    url=os.getenv('NEO4J_URI'),
    username=os.getenv('NEO4J_USERNAME'),
    password=os.getenv('NEO4J_PASSWORD'),
    database=os.getenv('NEO4J_DATABASE'),  # neo4j by default
    index_name="myVectorIndex",  # vector by default
    node_label="Chunk",  # Chunk by default
    text_node_property="text",  # text by default
    embedding_node_property="embedding",  # embedding by default
    create_id_index=True,  # True by default
)
----


=== Using an existing index

* You can also use an existing index.
* The following code creates an object that will read the `moviePlots` database

[source,python]
----
existing_index = Neo4jVector.from_existing_index(
    embedding_provider,
    url=os.getenv('NEO4J_URI'),
    username=os.getenv('NEO4J_USERNAME'),
    password=os.getenv('NEO4J_PASSWORD'),
    index_name="moviePlots",
    embedding_node_property="embedding",  # embedding by default
    text_node_property="plot",  # Need to define if it is not default
)
----

=== Fetching Documents

* To fetch documents, call the `similarity_search()` method
* One positional argument: question
* keyword argument `k` specifies the number of documents to return

existing_index.similarity_search("What do you know about LangChain?", k=1)

[TIP]
.Improving Results
Querying a vector index  returns approximate nearest neighbours using the Hierarchical Navigable Small World (HNSW) algorithm.
The higher the `k` value is, the better quality results you will receive.
The value you set `k` to is a trade-off between quality and performance


=== Customizing Queries

* You can customize the underlying Cypher query that returns results
* You can use this to exclude results

[source,python]
----
retrieval_query = """
WITH node, score, collect(p) AS editors
RETURN node.info AS text,
       score,
       node {.*, vector: Null, info: Null, editors: editors} AS metadata
"""

existing_index = Neo4jVector.from_existing_index(
    OpenAIEmbeddings(),
    url=os.getenv('NEO4J_URI'),
    username=os.getenv('NEO4J_USERNAME'),
    password=os.getenv('NEO4J_PASSWORD'),
    index_name="moviePlots",
    text_node_property="embedding",
    retrieval_query=retrieval_query,
)
----


== Check Your Understanding

TODO


[.summary]
== Summary

In this lesson, you learned how to do something

In the next lesson, you will learn how to do something else...
