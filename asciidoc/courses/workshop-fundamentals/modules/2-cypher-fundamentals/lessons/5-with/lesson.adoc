= Pipelining with `WITH`
:type: lesson
:order: 5
:sandbox: true

== What is WITH?

In Cypher, the `WITH` clause is used to:

. Chain parts of a query together.
. Control query flow.
. Aggregate data and pass it to the next part of the query.
. Filter results after aggregation.

Itâ€™s similar to `RETURN`, but instead of just returning data, `WITH` is used to pass data to the next part of the query.

== Filter After Aggregation

You can use `WITH` to filter results after aggregation.

Get people who have rated more than 5 movies.

[cypher, source]
----
MATCH (u:User)-[:RATED]->(m:Movie)
WITH u, count(m) AS movieCount
WHERE movieCount > 5
RETURN u.name, movieCount
----

What's happening:
- Match users who rated movies.
- Use `WITH` to count how many movies each person rated.
- Filter based on the aggregation.
- Return the results.

== Sort and Limit

Get the top 3 most-rated movies.

[cypher, source]
----
MATCH (:Person)-[r:RATED]->(m:Movie)
WITH m, count(r) AS ratings
ORDER BY ratings DESC
LIMIT 3
RETURN m.title, ratings
----

Why use WITH here?
- You aggregate (count ratings) and sort the results.
- Then limit before returning the data.


== Chaining with WITH

You can chain queries together using `WITH`.

MATCH (u:User)-[:RATED]->(m:Movie {title: "The Matrix"})
WITH u
MATCH (u)-[r:RATED]->(other:Movie)
WHERE other <> m
RETURN p.name, other.title, r.rating


Key idea: Use WITH p to carry the person forward into the next part of the query.


== Challenges

Get the top 5 people who gave the highest average rating. Return their name and average rating.

ðŸ’¡ Hint: You'll need avg() and WITH to group and order results.


Find all movies rated by people who have rated more than 10 movies.

ðŸ’¡ Hint: Use WITH to filter out people first, then find their rated movies.