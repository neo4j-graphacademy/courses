= Vector + Cypher retriever
:type: lesson
:order: 1
:branch: main

The chunks in the knowledge graph include vector embeddings that allow for similarity search based on vector distance.

You can create a vector retriever that uses these embeddings to find the most relevant chunks for a given query.

The retriever can then use the structured and unstructured data in the knowledge graph to provide additional context.

== Create the Vector Index

You will need to create a vector index on the `Chunk` nodes `embedding` properties:

[source, cypher]
----
CREATE VECTOR INDEX chunkEmbedding IF NOT EXISTS
FOR (n:Chunk)
ON n.embedding
OPTIONS {indexConfig: {
 `vector.dimensions`: 1536,
 `vector.similarity_function`: 'cosine'
}};
----

A vector index named `chunkEmbedding` will be created for nodes with a `Chunk` label, indexing the `embedding` property.
The index is configured to 1536 dimensions (as provided by the `text-embedding-ada-002` embedding model) and use cosine similarity for distance calculations.

You can search the vector index by creating an embedding for a search term:

[source, cypher]
----
WITH genai.vector.encode(
    "Retrieval Augmented Generation",
    "OpenAI",
    { token: "sk-..." }) AS userEmbedding
CALL db.index.vector.queryNodes('chunkEmbedding', 5, userEmbedding)
YIELD node, score
RETURN node.text, score
----

[IMPORTANT]
.OpenAI token
====
You will need to update the `$token` with your OpenAI API key.
====

== Create a Vector + Cypher GraphRAG pipeline

The `neo4j_graphrag` package includes a `VectorCypherRetriever` class that combines vector similarity search with Cypher retrieval.

You can use this retriever to create a `GraphRAG` pipeline to:

. Perform a vector similarity search to find the most relevant chunks for a given query.
. Use a Cypher query to add additional information to the context.
. Pass the context to an LLM to generate a response to the original query.

Open `genai-graphrag-python/vector_cypher_rag.py` and review the code:

[source, python]
.vector_cypher_rag.py
----
include::{repository-raw}/{branch}/genai-graphrag-python/vector_cypher_rag.py[]
----

The retriever is configured to use the `chunkEmbedding` vector index you just created.

[source, python]
.Retriever initialization
----
include::{repository-raw}/{branch}/genai-graphrag-python/solutions/vector_cypher_rag.py[tag=retriever]
----

When you run the code:

. The `VectorCypherRetriever` uses the vector index to find chunks similar to the query:
+
_"Where can I learn more about knowledge graphs?"_
. The `GraphRAG` pipeline passes the text from those chunks as context to the LLM.
. The response from the LLM is printed:
+
_You can learn more about knowledge graphs in the Neo4j blog post linked here: link:https://neo4j.com/blog/what-is-knowledge-graph[What Is a Knowledge Graph?^]_

You can print the context passed to the LLM by adding the following to the end of the code:

[source, python]
.Print context
----
include::{repository-raw}/{branch}/genai-graphrag-python/solutions/vector_cypher_rag.py[tag=print_context]
----

== Retrieval Cypher Query

The `VectorCypherRetriever` also allows you to define a Cypher query to retrieve additional context from the knowledge graph.

Adding additional context can help the LLM generate more accurate responses.

Update the `retrieval_query` to add additional information about the lessons, technologies, and concepts related to the chunks:

[source, python]
.Enhanced retrieval query
----
include::{repository-raw}/{branch}/genai-graphrag-python/solutions/vector_cypher_rag.py[tag=retrieval_query]
----

The retriever will execute the Cypher query adding more context.

Running the code again for the same query, _"Where can I learn more about knowledge graphs?"_, will produce a more detailed response:

_You can learn more about knowledge graphs in the Neo4j blog post linked here: link:https://neo4j.com/blog/what-is-knowledge-graph[What Is a Knowledge Graph?^]. Additionally, you can explore further lessons on knowledge graphs on the GraphAcademy website, specifically in the course "GenAI Fundamentals," including the sections "What is a Knowledge Graph" and "Creating Knowledge Graphs."_

The retrieval query includes additional context relating to technologies and concepts mentioned in the chunks.

Experiment asking different questions relating to the knowledge graph such as _"What technologies and concepts support knowledge graphs?"_.

[.quiz]
== Check your understanding

include::questions/1-graphrag-pipeline.adoc[leveloffset=+2]

[.summary]
== Lesson Summary

In this lesson, you:

* Created a vector index on the `Chunk` nodes in the knowledge graph.
* Used the `VectorCypherRetriever` to perform vector similarity search and Cypher retrieval.
* Created a `GraphRAG` pipeline to generate responses with context from the knowledge graph.

In the next lesson, you will use the `Text2CypherRetriever` retriever to get information from the knowledge graph based on natural language questions.
