= Cypher Generation
:order: 2
:type: lesson


Few shot prompting 

- examples

Schema 

- include or exclude types



To improve the accuracy of the generated Cypher queries you customize the generation prompt and the configure the schema.

== Prompt

You can provide a custom prompt the the `GraphCypherQAChain`, where you can include examples of Cypher queries and answers to help the LLM understand the context and generate more accurate Cypher queries.

Update the `cypher_qa.py` program to include a custom prompt:

[source,python]
----
include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=import_prompt]

include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=cypher_template]

include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=cypher_prompt]
----

The prompt includes instructions for generating Cypher queries including parameters for the `schema`, and `question` to be inserted by the `GraphCypherQAChain`.

Add the custom prompt to the `GraphCypherQAChain`:

[source,python]
----
include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=cypher_qa]
----

== Specific instructions

You might need to provide specific instructions to the LLM when generating the Cypher, this could be to manage specific data or business rules.

For example, movie titles that start with "The" are stored in the graph as "Matrix, The" instead of "The Matrix".

Asking the LLM to generate Cypher queries without this context will result in no data being returned.

    [user]
    Who acted in the movie The Matrix?

    [assistant]
    I don't know.

Update the `cypher_template` to include a specific instruction to the LLM to handle this case:` 

    For movie titles that begin with "The", move "the" to the end, 
    for example "The 39 Steps" becomes "39 Steps, The".

[%collapsible]
.Click to view the complete prompt
====
[source,python]
----
include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=cypher_template_instructions]
----
====

Update to ask the same question - "Who acted in the movie The Matrix?", run the program and review the results.

== Examples

You can provide examples of Cypher queries and answers to help the LLM understand the context and generate more accurate Cypher queries.

Questions that relate to movies ratings often generate ambiguous or incorrect Cypher.
This is because the rating is a property of the `RATED` relationship, and the `Movie` node also includes a `imdbRating` property.

Cypher examples should describe the query and the expected Cypher query, for example:

    Question: Get user ratings?
    Cypher: MATCH (u:User)-[r:RATED]->(m:Movie) 
            WHERE u.name = "User name" 
            RETURN r.rating AS userRating

Update the `cypher_template` to include the examples relating to movie ratings:

[source,python]
----
include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=cypher_template_examples]
----

== Genres

The database contains data about movie genres. 

When generating more complex Cypher queries, such as those that involve genres, the LLM may not generate the correct Cypher query:

    include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tag=examples_genre]

Your challenge is to provide an example Cypher query that demonstrates how to retrieve genres from the graph.

[%collapsible]
.Click to view the complete code
====
include::{repository-raw}/{branch}/genai-integration-langchain/solutions/cypher_qa_prompt.py[tags=**, !cypher_template, !cypher_template_instructions, !cypher_template_examples, !examples_the, !examples_rating, !examples_genre]
====

== Continue

When you are ready, continue to the next lesson.

read::Continue[]

[.summary]
== Lesson Summary

In this lesson, you learned how you can improve the quality of the generated Cypher queries by customizing the prompt and providing specific instructions to the LLM.

In the next lesson, you will learn how to restrict the schema used to generate Cypher queries.
