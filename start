#! /bin/sh

echo "Saving credentials..."
echo $GOOGLE_APPLICATION_CREDENTIALS_CONTENT >> $GOOGLE_APPLICATION_CREDENTIALS
echo $GOOGLE_APPLICATION_CREDENTIALS
cat $GOOGLE_APPLICATION_CREDENTIALS

RELEASE=$(curl -q https://api.github.com/repos/neo4j-graphacademy/courses/tags | jq 'sort_by( .name | ltrimstr("v") | split(".") | map(tonumber) ) | reverse |.[0].zipball_url' | tr -d '"')

echo "Downloading $RELEASE"

wget -q -O /tmp/content.zip $RELEASE
unzip -q -d /tmp/content /tmp/content.zip

if [[ $? -gt 0 ]]; then
   echo "Unzipping content failed, either because of bad file or failure to download zip"
   exit 1
fi

cp -rf /tmp/content/*/asciidoc/ /app/ 2>/dev/null

node --max-http-header-size=24000 /app/dist/main.js
